---
title: "VIS_assignment 03"
author: "Mengyao"
date: "2020/9/25"
output: 
  html_document:
    theme: lumen
    toc: true
    toc_float: true
---

# Loading packages
```{r, message=FALSE}
library(sf)
library(tidyverse)
library(ggthemes)
library(ggspatial)
library(units)
library(nngeo)
```

# Loading data

I will read in all four datasets (neighborhood boundaries, parks, public schools, and crime) from the Chicago open data portal. 

```{r}
neighborhood <- st_read("https://data.cityofchicago.org/api/geospatial/bbvz-uum9?method=export&format=KML", quiet = TRUE)
park <- st_read("https://data.cityofchicago.org/api/geospatial/ej32-qgdr?method=export&format=KML", quiet = TRUE)
pub_school <- st_read("https://data.cityofchicago.org/api/geospatial/3fhj-xtn5?method=export&format=KML", quiet = TRUE)
bus <- st_read("https://data.cityofchicago.org/download/84eu-buny/text%2Fxml", quiet = TRUE)
```

# Transforming data

I will transfrom my data to the Illinois East coordinate system.

```{r}
illinois_east <- "+proj=tmerc +lat_0=36.66666666666666 +lon_0=-88.33333333333333 +k=0.9999749999999999 +x_0=300000 +y_0=0 +ellps=GRS80 +units=m +no_defs "

NEIGHBORHOOD <- neighborhood %>%
  st_transform(crs = illinois_east)

PARK <- park %>%
  st_transform(crs = illinois_east)

PUB_SCHOOL <- pub_school %>%
  st_transform(crs = illinois_east)

BUS <- bus %>%
  st_transform(crs = illinois_east)
```

Quick visualization of the data.
```{r, fig.width=8, fig.height=8}
ggplot(NEIGHBORHOOD) +
  geom_sf() +
  geom_sf(data = PARK, fill = "lightgreen", color = NA) +
  geom_sf(data = PUB_SCHOOL, size = 0.05) +
  geom_sf(data = BUS, color = "blue", size = 0.01) +
  theme_map() +
  annotation_scale()
```

# Creating a buffer

I would like to know: how many of the bus stops in Chicago are within 30 meters of a public school? To figure this out, I will create a new polygon layer to represent a 200-meter buffer around the public schools. 
```{r}
school_buffer <- st_buffer(PUB_SCHOOL, dist = 200) %>%
  st_union()

ggplot(school_buffer) +
  geom_sf() +
  theme_map()
```

# Subsetting points with a polygon

Now I can create a dataframe that only includes bus stops that are located within the public school buffer. Then we can see how that subset of bus stops looks on the map. I will draw them on top of the public school buffer.
```{r}
bus_school <- BUS[school_buffer,]

ggplot(school_buffer) +
  geom_sf() +
  geom_sf(data = bus_school, color = "blue", size = 0.01) +
  theme_map()
```

Now I will join my two bus dataframes. For any trees that are in the BUS dataset, but not in bus_school, there will be an NA value for the variables Name.y and Description.y. Baed on which values of Name.y are NA, I can create a binary variable that indicated whether each bus stop is by a public school.
```{r}
BUS_new <- BUS %>%
  st_join(bus_school) %>%
  mutate(by_school = !is.na(Name.y))
```

Now we can calculate how many bus stops are within 200 meters of a public school.
```{r}
n_bus_school <- sum(BUS_new$by_school)
n_bus_school
```

And what percent of all bus stops does this represent?
```{r}
n_bus <- length(BUS_new$by_school)
pct_bus_school <- n_bus_school / n_bus
pct_bus_school
```

About 14% of all bus stops in Chicago are within 200 meters of a public school.

Visualization of the data.
```{r, fig.width=8, fig.height=8}
left_side <- st_bbox(BUS_new)$xmin
top_side <- st_bbox(BUS_new)$ymax

ggplot(NEIGHBORHOOD) +
  geom_sf() + 
  geom_sf(data = BUS_new, size = 0.01,
          aes(color = by_school)) +
  scale_color_manual(values = c("lightblue", "blue"),
                     name = "Chicago Bus Stops\nby distance to a public school",
                     labels = c("No public school within 200 m",
                                "Public school within 200m")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_fancy_orienteering()) +
  annotate(geom = "text", 
           x = left_side - 3000,
           y = top_side - 3000,
           label = paste("Of the ", prettyNum(n_bus, big.mark = ","), " bus stops in Chicago\n",
                         prettyNum(n_bus_school, big.mark = ","), " (",
                         prettyNum(100*pct_bus_school, digits = 0),
                         "%) are within 200\nmeters of a parking meter.", sep = ""),
           hjust = 0, vjust = 0, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "cornsilk1"),
        legend.background = element_rect(fill = alpha("white", 0.5),
                                         color = "gray"))
```

# Counting points in a polygon

I wanted to know how many public schools are in each Chicago neighborhood.
```{r}
NEIGHBORHOOD_2 <- NEIGHBORHOOD %>%
  mutate(num_schools = lengths(st_covers(NEIGHBORHOOD, PUB_SCHOOL)))

ggplot(NEIGHBORHOOD_2) +
  geom_sf(color = NA,
          aes(fill = num_schools)) +
  scale_fill_viridis_c(name = "Chicago neighborhoods by\nnumber of public schools",
                       breaks = breaks <- seq(0, 35, by = 5),
                       labels = paste(prettyNum(breaks), "public schools")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr", 
                         style = north_arrow_fancy_orienteering()) +
  theme_map() +
  theme(legend.background = element_rect(fill = alpha("white", 0.5),
                                         color = "gray"))
```

# Calculating areas and densities

I am more interested in the density of bus stops (the number of bus stops per square km).

```{r}
NEIGHBORHOOD_3 <- NEIGHBORHOOD %>%
  mutate(num_bus = lengths(st_covers(NEIGHBORHOOD, BUS_new))) %>%
  mutate(area = set_units(st_area(NEIGHBORHOOD), km^2)) %>%
  mutate(bus_dens = as.numeric(num_bus / area))

ggplot(NEIGHBORHOOD_3) +
  geom_sf(color = NA,
          aes(fill = bus_dens)) +
  scale_fill_viridis_c(name = "Chicago neighborhoods\nbus stop density",
                       trans = "log",
                       breaks = breaks <- c(3, 9, 27, 81, 243),
                       labels = paste(prettyNum(breaks), "bus stops per square km")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_fancy_orienteering()) +
  theme_map() +
  theme(legend.position = "right",
        legend.background = element_rect(fill = alpha("white", 0.5),
                                         color = "gray"))
```

# Finding the closest point

I want to know how far each school is from a bus stop.
```{r}
# PUB_SCHOOL_2 <- PUB_SCHOOL %>%
 # mutate(bus_dist = st_nn(PUB_SCHOOL, BUS,
 #                        returnDist = TRUE)$dist) # %>%
 # mutate(bus_dist = as.numeric(bus_dist))
```

# Identifying overlapping polygons

I would like to know which neighborhoods have parks in them. 

```{r}
NEIGHBORHOOD_4 <- NEIGHBORHOOD %>%
  mutate(num_park = lengths(st_overlaps(NEIGHBORHOOD, PARK))) %>%
  mutate(has_park = num_park >0)

n_park_nhoods <- sum(NEIGHBORHOOD_4$has_park)
n_park_nhoods
```

```{r}
left_side <- st_bbox(PARK)$xmin
top_side <- st_bbox(PARK)$ymax

ggplot(PARK) +
  geom_sf(fill = "lightgreen", color = NA) +
  geom_sf(data = NEIGHBORHOOD_4,
           aes(fill = has_park)) +
  scale_fill_manual(values = c("cornsilk1", "darkseagreen1"),
                    name = "Chicago Neighborhoods\nby preserce of a park",
                    labels = c("Neighborhood without an\noverlapping park",
                               "Neighborhood with an\noverlapping park")) +
  annotation_scale(location = "br") +
  annotation_north_arrow(location = "tr",
                         style = north_arrow_fancy_orienteering()) +
  annotate(geom = "text", 
           x = left_side - 8000,
           y = top_side - 1000,
           label = paste(n_park_nhoods, "of Chicago's", length(NEIGHBORHOOD_4$Name), "neighborhoods contain\nor overlap with a body of water."),
           hjust = 0, vjust = 0, size = 3) +
  theme_map() +
  theme(panel.background = element_rect(fill = "gray"),
        legend.background = element_rect(fill = alpha("white", 0.5),
                                          color = "gray"))
```



